import{r as h,j as e}from"./react-BBjJjj3s.js";import{aB as H,aD as V,aS as M,aT as T,aU as W,aV as q}from"./vendor-BSC4DWPL.js";import{d as x,C as X,a as Z,b as K,B,c as Y,e as p,T as C,f as ee,g as R,h as i,i as se,j as c,k as b,l as E,s as ae}from"./index-DPqP4iXg.js";import{O as z,z as _,A as U,D as J,B as le,E as re,F as te,G as ne}from"./radix-Dv_jxVmT.js";import"./three-s7DBp6_P.js";import"./xlsx-uoQkVabA.js";const oe=le,ie=re,ce=te,de=ne,A=h.forwardRef(({className:n,...r},o)=>e.jsx(z,{ref:o,className:x("fixed inset-0 z-50 bg-black/40 backdrop-blur-sm data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",n),...r}));A.displayName=z.displayName;const L=h.forwardRef(({className:n,children:r,...o},j)=>e.jsxs(ce,{children:[e.jsx(A,{}),e.jsxs(_,{ref:j,className:x("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-card p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",n),...o,children:[r,e.jsxs(de,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[e.jsx(H,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Close"})]})]})]}));L.displayName=_.displayName;const $=({className:n,...r})=>e.jsx("div",{className:x("flex flex-col space-y-1.5 text-center sm:text-left",n),...r});$.displayName="DialogHeader";const F=h.forwardRef(({className:n,...r},o)=>e.jsx(U,{ref:o,className:x("text-lg font-semibold leading-none tracking-tight",n),...r}));F.displayName=U.displayName;const me=h.forwardRef(({className:n,...r},o)=>e.jsx(J,{ref:o,className:x("text-sm text-muted-foreground",n),...r}));me.displayName=J.displayName;function ue({selectedItems:n,supplierCodes:r,allItems:o,poTemplateHeaders:j,auditContext:a}){const[I,y]=h.useState(!1),[d,w]=h.useState([]),f=n.length>0?n:o.filter(s=>s.finalReorderQty>0),g=async(s,t)=>{var u,N;const l=t??`snapshot-${Date.now()}`;await ae({id:l,createdAt:Date.now(),sourceFilename:((u=a==null?void 0:a.meta)==null?void 0:u.sourceFilename)||"PO Export",rowCount:s.length,payload:{forecast:((N=a==null?void 0:a.processed)==null?void 0:N.forecast)||[],kpis:(a==null?void 0:a.kpis)||{totalOrderValue:0,itemsBelowSafetyStock:0,avgStockCoverageDays:0,ordersBySupplierCount:0,criticalItemsCount:0},chartData:(a==null?void 0:a.chartData)||{weeklyDemandTrend:[],topProductsByValue:[],supplierBreakdown:[],stockStatusDistribution:[],warehouseLevelDistribution:[]}}})},Q=()=>{const s=b(f,r);w(s),y(!0),g(s)},D=()=>{if(d.length===0){const s=b(f,r);w(s),g(s),E(s,`PO_Template_${new Date().toISOString().split("T")[0]}.xlsx`,j)}else g(d),E(d,`PO_Template_${new Date().toISOString().split("T")[0]}.xlsx`,j)},O=async()=>{var k,P;const s=d.length>0?d:b(f,r);d.length===0&&w(s);const t=`snapshot-${Date.now()}`;await g(s,t);const l=new q,u=new Date().toISOString();l.file("metadata.json",JSON.stringify({timestamp:u,dataset:(a==null?void 0:a.meta)||null,poRows:s.length},null,2)),a!=null&&a.processed&&(l.file("normalized/forecast.json",JSON.stringify(a.processed.forecast,null,2)),l.file("normalized/supplier_codes.json",JSON.stringify(a.processed.supplierCodes,null,2)),l.file("normalized/sales_order_pivot.json",JSON.stringify(a.processed.salesOrderPivot,null,2)),l.file("normalized/inventory_balance.json",JSON.stringify(a.processed.inventoryBalance,null,2))),l.file("po_results.json",JSON.stringify(s,null,2)),(k=a==null?void 0:a.rawFiles)!=null&&k.length?a.rawFiles.forEach(m=>{l.file(`source/${m.name}`,m.arrayBuffer)}):(P=a==null?void 0:a.files)!=null&&P.length&&a.files.forEach(m=>{m.arrayBuffer&&l.file(`source/${m.name}`,m.arrayBuffer)});const N=await l.generateAsync({type:"blob"}),S=URL.createObjectURL(N),v=document.createElement("a");v.href=S,v.download=`audit-pack-${t}.zip`,v.click(),URL.revokeObjectURL(S)},G=f.reduce((s,t)=>{const l=t.supplier||t.supplierCode||"Unknown";return s[l]||(s[l]={count:0,totalQty:0}),s[l].count++,s[l].totalQty+=t.finalReorderQty,s},{});return e.jsxs(X,{children:[e.jsx(Z,{className:"pb-3",children:e.jsxs(K,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(V,{className:"h-5 w-5 text-primary"}),"PO Template Generator"]}),e.jsxs(B,{variant:"outline",children:[f.length," items to order"]})]})}),e.jsxs(Y,{className:"space-y-4",children:[e.jsx("div",{className:"grid gap-2 sm:grid-cols-2 lg:grid-cols-3",children:Object.entries(G).slice(0,6).map(([s,t])=>e.jsxs("div",{className:"flex items-center justify-between rounded-lg border bg-muted/30 p-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium truncate max-w-[120px]",children:s}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[t.count," items"]})]}),e.jsxs(B,{variant:"secondary",children:[t.totalQty.toLocaleString()," units"]})]},s))}),e.jsxs("div",{className:"flex flex-wrap gap-3 pt-2",children:[e.jsxs(oe,{open:I,onOpenChange:y,children:[e.jsx(ie,{asChild:!0,children:e.jsxs(p,{variant:"outline",onClick:Q,children:[e.jsx(M,{className:"mr-2 h-4 w-4"}),"Preview PO"]})}),e.jsxs(L,{className:"max-w-4xl max-h-[80vh] overflow-hidden",children:[e.jsx($,{children:e.jsx(F,{children:"PO Template Preview"})}),e.jsx("div",{className:"overflow-auto max-h-[60vh]",children:e.jsxs(C,{children:[e.jsx(ee,{children:e.jsxs(R,{children:[e.jsx(i,{children:"WHS Code"}),e.jsx(i,{children:"Owner"}),e.jsx(i,{children:"PO No"}),e.jsx(i,{children:"PO Date"}),e.jsx(i,{children:"ETA Date"}),e.jsx(i,{children:"Supplier"}),e.jsx(i,{children:"Product"}),e.jsx(i,{className:"text-right",children:"Qty"}),e.jsx(i,{children:"UOM"})]})}),e.jsx(se,{children:d.map((s,t)=>e.jsxs(R,{children:[e.jsx(c,{className:"font-mono text-xs",children:s.whsCode}),e.jsx(c,{children:s.owner}),e.jsx(c,{className:"font-mono text-xs",children:s.poNo}),e.jsx(c,{className:"text-xs",children:s.poDate}),e.jsx(c,{className:"text-xs",children:s.etaDate}),e.jsx(c,{children:e.jsxs("div",{children:[e.jsx("p",{className:"text-sm",children:s.supplierName}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s.supplierCode})]})}),e.jsx(c,{className:"font-mono text-xs",children:s.product}),e.jsx(c,{className:"text-right font-mono",children:s.qtyOrdered.toLocaleString()}),e.jsx(c,{className:"text-xs",children:s.origUomCode})]},t))})]})}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t",children:[e.jsx(p,{variant:"outline",onClick:()=>y(!1),children:"Close"}),e.jsx(p,{variant:"outline",onClick:O,children:"Download Audit Pack"}),e.jsxs(p,{onClick:D,children:[e.jsx(T,{className:"mr-2 h-4 w-4"}),"Download Excel"]})]})]})]}),e.jsxs(p,{onClick:D,className:"gradient-primary",children:[e.jsx(T,{className:"mr-2 h-4 w-4"}),"Export to Excel"]}),e.jsx(p,{variant:"outline",onClick:O,children:"Download Audit Pack"})]}),e.jsxs("div",{className:"flex items-start gap-2 rounded-lg bg-info/10 p-3 text-sm",children:[e.jsx(W,{className:"h-4 w-4 text-info mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-info",children:"Ready for WMS Upload"}),e.jsx("p",{className:"text-muted-foreground text-xs",children:"Template includes: whs_code (8JB), Owner (CPS), Trans_Code (GI), and all supplier details from Supplier Code tab."})]})]})]})]})}export{ue as POGenerator};
